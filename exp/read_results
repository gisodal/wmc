#!/bin/bash

SCRIPT=$(basename "$0")
if [ $# -ne 1 ]; then
    echo "Usage: ./$SCRIPT <newline separated networks file>" 1>&2
    exit 1
fi

NETS=$1


trim()
{
    local trimmed="$1"

    # Strip leading space.
    trimmed="${trimmed## }"
    # Strip trailing space.
    trimmed="${trimmed%% }"

    echo "$trimmed"
}

function clear_results(){
    NODES=""
    OPERATORS=""
    TIME_CPTS=""
    TIME_CONJOINED=""
    TIME_TOTAL=""
}

function read_results(){
    FILE=$1
    NODES=$(trim $(cat $FILE | command grep -i "total.*nodes" | cut -d : -f2))
    OPERATORS=$(trim $(cat $FILE | command grep -i "total.*operators" | cut -d : -f2))
    TIME_CPTS=$(trim $(cat $FILE | command grep -i "compiled cpts" | cut -d : -f2) | tail -1 | sed 's:s::')
    TIME_CONJOINED=$(trim $(cat $FILE | command grep -i "conjoined cpts" | cut -d : -f2 | sed 's:s::'))
    TIME_TOTAL=$(trim $(cat $FILE | command grep -i "total time" | cut -d : -f2 | sed 's:s::'))
}

function write_header(){
    echo "BN & OPERATORS & CPT_TIME & CONJOIN_TIME & TOTAL_TIME"
}

function write_results(){
    echo "$NET & ${OPERATORS:--} & ${TIME_CPTS:--} & ${TIME_CONJOINED:--} & ${TIME_TOTAL:--}"
}

function print_results(){

    write_header
    for NET in $(cat $NETS); do
        source scripts/environment $NET

        clear_results
        FILE=$(eval echo "\$$1")
        if [ -f $FILE ]; then
            read_results $FILE
        else
            echo "'$FILE' does not exist"
        fi
        write_results
    done
}

function print_all_results(){
    echo -e "WPBDD"
    print_results DEFAULT_OUTFILE

    echo -e "\nPWPBDD"
    print_results PART_OUTFILE

    echo -e "\nWPBDD-nc"
    print_results CIRCUIT_OUTFILE

    echo -e "\nPWPBDD-nc"
    print_results PART_CIRCUIT_OUTFILE

    echo -e "\nOBDD"
    print_results OBDD_OUTFILE

    echo -e "\nSDD"
    print_results SDD_OUTFILE
}

RESULTS_OUTFILE="results.out"
> $RESULTS_OUTFILE

print_all_results | tee >(column -t > $RESULTS_OUTFILE)

echo -e "\nResults written to file '$RESULTS_OUTFILE'"

